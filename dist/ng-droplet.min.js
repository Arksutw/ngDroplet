!function(e){"use strict";var t=e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout","$q",function(t,r,s,i){return{restrict:"EA",require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(n){n.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},n.files=[],n.isUploading=!1,n.isError=!1,n.options={disableXFileSize:!1,useArray:!0,statuses:{success:[200,201,202,203,204,205,206,207,208,226]}},n.extensions=[],n.requestUrl="",n.requestProgress={percent:0,total:0,loaded:0},n.requestHeaders={},n.requestPostData={},n.listeners={files:[],httpRequest:{},deferred:{},success:function(){this.httpRequest.onreadystatechange=function(){var s=n.options.statuses.success;if(4===this.httpRequest.readyState){if(-1!==s.indexOf(this.httpRequest.status))return void n.$apply(function(){var s=r.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletSuccess",s,this.files),this.deferred.resolve(s,this.files),n.finishedUploading(),e.forEach(this.files,function(e){e.type=n.FILE_TYPES.UPLOADED})}.bind(this));this.httpRequest.upload.onerror()}}.bind(this)},error:function(){this.httpRequest.upload.onerror=function(){n.$apply(function(){n.finishedUploading(),n.isError=!0;var e=r.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletError",e),this.deferred.reject(e)}.bind(this))}.bind(this)},progress:function(){var e=n.getRequestLength(this.files);this.httpRequest.upload.onprogress=function(t){n.$apply(function(){t.lengthComputable&&(n.requestProgress.percent=Math.round(t.loaded/e*100),n.requestProgress.loaded=t.loaded,n.requestProgress.total=e)})}}},function(){n.DropletModel=function(){},n.DropletModel.prototype={load:function(e,t){this.file=e,this.type=t,this.date=new r.Date,this.mimeType=e.type,this.extension=n.getExtension(e)},deleteFile:function(){n.deleteFile(this)},isImage:function(){return!!this.file.type.match(/^image\//i)}}}(),n.finishedUploading=function(){n.progress={percent:0,total:0,loaded:0},n.isUploading=!1},n.forEachFile=function(t,r){e.forEach(n.filterFiles(t||n.FILE_TYPES.VALID),function(e){r(e)})},n.addFile=function(e,t){t=t||n.FILE_TYPES.VALID;var r=new n.DropletModel;return r.load(e,t),n.files.push(r),r},n.deleteFile=function(e){e instanceof n.DropletModel||n.throwException("Method expects an instance of DropletModel"),e.type=n.FILE_TYPES.DELETED},n.filterFiles=function(e){return n.files.filter(function(t){return e&t.type})},n.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},n.traverseFiles=function(e){n.$apply(function(){for(var t=0,r=e.length;r>t;t++){var s=e[t],i=n.getExtension(s),o=n.FILE_TYPES.VALID;-1===n.extensions.indexOf(i)&&(o=n.FILE_TYPES.INVALID),n.addFile(s,o)}})},n.uploadFiles=function(){n.isError=!1;var t=new r.XMLHttpRequest,s=new r.FormData,o=n.filterFiles(n.FILE_TYPES.VALID),a=n.options.useArray?"file[]":"file",l=n.getRequestLength(o),u=i.defer();return t.open("post",n.requestUrl,!0),function(){n.options.disableXFileSize||t.setRequestHeader("X-File-Size",l),n.addRequestHeaders(t),n.addPostData(s)}(),function(){n.listeners.files=o,n.listeners.deferred=u,n.listeners.httpRequest=t,n.listeners.progress(),n.listeners.success(),n.listeners.error()}(),e.forEach(o,function(e){s.append(a,e.file)}),n.isUploading=!0,t.send(s),u.promise},n.addRequestHeaders=function(e){for(var t in n.requestHeaders)n.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,n.requestHeaders[t]);return Object.keys(n.requestHeaders)},n.addPostData=function(e){for(var t in n.requestPostData)n.requestPostData.hasOwnProperty(t)&&e.append(t,n.requestHeaders[t]);return Object.keys(n.requestPostData)},n.getRequestLength=function(t){var r=0;return e.forEach(t||n.filterFiles(n.FILE_TYPES.VALID),function(e){r+=e.file.size}),r},n.throwException=function(e){throw"ngDroplet: "+e+"."},function(){n.directiveInterface={FILE_TYPES:n.FILE_TYPES,uploadFiles:n.uploadFiles,progress:n.requestProgress,isUploading:function(){return n.isUploading},isError:function(){return n.isError},isReady:function(){return!!n.filterFiles(n.FILE_TYPES.VALID).length},addFile:n.addFile,traverseFiles:n.traverseFiles,disableXFileSize:function(){n.options.disableXFileSize=!0},useArray:function(e){n.options.useArray=!!e},setRequestUrl:function(e){n.requestUrl=e},setRequestHeaders:function(e){n.requestHeaders=e},setPostData:function(e){n.requestPostData=e},getFiles:function(e){return e?n.filterFiles(e):n.files},allowedExtensions:function(t){e.isArray(t)||n.throwException("Extensions must be an array"),n.extensions=t}},s(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var r=function(e){t.removeClass("event-dragleave"),t.removeClass("event-dragenter"),t.removeClass("event-dragover"),t.removeClass("event-drop"),t.addClass("event-"+e.type),e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",r),t.bind("drop",function(t){r(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<img ng-show="model.isImage()" ng-src="{{imageData}}" class="droplet-preview" />',link:function(t){t.imageData="";var r=new e.FileReader;r.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.model.isImage()&&r.readAsDataURL(t.model.file)}}}]);!function(){var e=function(e,r){t.directive(e,function(){return{restrict:"EA",require:"ngModel",replace:!0,template:r,scope:{"interface":"=ngModel"},link:function(e,t){t.bind("change",function(){e.interface.traverseFiles(t[0].files)})}}})};e("dropletUploadSingle",'<inputclass="droplet-upload droplet-single" type="file" />'),e("dropletUploadMultiple",'<input class="droplet-upload droplet-multiple" type="file" multiple="multiple" />')}()}(window.angular);