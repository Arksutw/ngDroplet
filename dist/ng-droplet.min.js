!function(e){"use strict";e.module("ngDroplet",[]).directive("droplet",["$rootScope","$window","$timeout","$q",function(t,r,n,s){return{restrict:"EA",require:"?ngModel",scope:{directiveInterface:"=ngModel"},controller:["$scope",function(i){i.FILE_TYPES={VALID:1,INVALID:2,DELETED:4,UPLOADED:8},i.files=[],i.isUploading=!1,i.isError=!1,i.options={disableXFileSize:!1,useArray:!0},i.extensions=[],i.requestUrl="",i.requestProgress={percent:0,total:0,loaded:0},i.requestHeaders={},i.requestPostData={},i.listeners={files:[],httpRequest:{},deferred:{},success:function(){this.httpRequest.upload.onload=function(){i.$apply(function(){i.finishedUploading(),i.forEachFile(i.FILE_TYPES.VALID,function(e){e.type=i.FILE_TYPES.UPLOADED})})}}.bind(this),finish:function(){this.httpRequest.onreadystatechange=function(){4===this.httpRequest.readyState&&0!==this.httpRequest.status&&i.$apply(function(){var e=r.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletSuccess",e,this.files),this.deferred.resolve(e,this.files)}.bind(this))}.bind(this)},error:function(){this.httpRequest.upload.onerror=function(){i.$apply(function(){i.finishedUploading(),i.isError=!0;var e=r.JSON.parse(this.httpRequest.responseText);t.$broadcast("$dropletError",e),this.deferred.reject(e)}.bind(this))}},progress:function(){var e=i.getRequestLength(this.files);this.httpRequest.upload.onprogress=function(t){i.$apply(function(){t.lengthComputable&&(i.requestProgress.percent=Math.round(t.loaded/e*100),i.requestProgress.loaded=t.loaded,i.requestProgress.total=e)})}}},function(){i.DropletModel=function(){},i.DropletModel.prototype={load:function(e,t){this.file=e,this.type=t,this.date=new r.Date,this.mimeType=e.type,this.extension=i.getExtension(e)},deleteFile:function(){i.deleteFile(this)},isImage:function(){return!!this.file.type.match(/^image\//i)}}}(),i.finishedUploading=function(){i.progress={percent:0,total:0,loaded:0},i.isUploading=!1},i.forEachFile=function(t,r){e.forEach(i.filterFiles(t||i.FILE_TYPES.VALID),function(e){r(e)})},i.addFile=function(e,t){t=t||i.FILE_TYPES.VALID;var r=new i.DropletModel;return r.load(e,t),i.files.push(r),r},i.deleteFile=function(e){e instanceof i.DropletModel||i.throwException("Method expects an instance of DropletModel"),e.type=i.FILE_TYPES.DELETED},i.filterFiles=function(e){return i.files.filter(function(t){return e&t.type})},i.getExtension=function(e){return e.name.split(".").pop().trim().toLowerCase()},i.traverseFiles=function(e){i.$apply(function(){for(var t=0,r=e.length;r>t;t++){var n=e[t],s=i.getExtension(n),o=i.FILE_TYPES.VALID;-1===i.extensions.indexOf(s)&&(o=i.FILE_TYPES.INVALID),i.addFile(n,o)}})},i.uploadFiles=function(){i.isError=!1;var t=new r.XMLHttpRequest,n=new r.FormData,o=i.filterFiles(i.FILE_TYPES.VALID),a=i.options.useArray?"file[]":"file",l=i.getRequestLength(o),u=s.defer();return t.open("post",i.requestUrl,!0),function(){i.options.disableXFileSize||t.setRequestHeader("X-File-Size",l),i.addRequestHeaders(t),i.addPostData(n)}(),function(){i.listeners.files=o,i.listeners.deferred=u,i.listeners.httpRequest=t,i.listeners.progress(),i.listeners.success(),i.listeners.error(),i.listeners.finish()}(),e.forEach(o,function(e){n.append(a,e.file)}),i.isUploading=!0,t.send(n),u.promise},i.addRequestHeaders=function(e){for(var t in i.requestHeaders)i.requestHeaders.hasOwnProperty(t)&&e.setRequestHeader(t,i.requestHeaders[t]);return Object.keys(i.requestHeaders)},i.addPostData=function(e){for(var t in i.requestPostData)i.requestPostData.hasOwnProperty(t)&&e.append(t,i.requestHeaders[t]);return Object.keys(i.requestPostData)},i.getRequestLength=function(t){var r=0;return e.forEach(t||i.filterFiles(i.FILE_TYPES.VALID),function(e){r+=e.file.size}),r},i.throwException=function(e){throw"ngDroplet: "+e+"."},function(){i.directiveInterface={FILE_TYPES:i.FILE_TYPES,uploadFiles:i.uploadFiles,progress:i.requestProgress,isUploading:function(){return i.isUploading},isError:function(){return i.isError},isReady:function(){return!!i.filterFiles(i.FILE_TYPES.VALID).length},addFile:i.addFile,disableXFileSize:function(){i.options.disableXFileSize=!0},useArray:function(e){i.options.useArray=!!e},setRequestUrl:function(e){i.requestUrl=e},setRequestHeaders:function(e){i.requestHeaders=e},setPostData:function(e){i.requestPostData=e},getFiles:function(e){return e?i.filterFiles(e):i.files},allowedExtensions:function(t){e.isArray(t)||i.throwException("Extensions must be an array"),i.extensions=t}},n(function(){t.$broadcast("$dropletReady")})}()}],link:function(e,t){var r=function(e){e.preventDefault(),e.stopPropagation()};t.bind("dragover dragenter dragleave",r),t.bind("drop",function(t){r(t),e.traverseFiles(t.dataTransfer.files)})}}}]).directive("dropletPreview",["$window",function(e){return{scope:{model:"=ngModel"},restrict:"E",replace:!0,template:'<img ng-show="model.isImage()" ng-src="{{imageData}}" class="droplet-preview" />',link:function(t){t.imageData="";var r=new e.FileReader;r.onload=function(e){t.$apply(function(){t.imageData=e.target.result})},t.model.isImage()&&r.readAsDataURL(t.model.file)}}}])}(window.angular);